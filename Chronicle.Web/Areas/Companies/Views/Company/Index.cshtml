@{
    ViewData["Title"] = "Company Management";
}

<!-- Content Header -->
<section class="content-header">
    <h1>
        Company Management
        <small>Manage business partners and contractors</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">Master Data</a></li>
        <li class="active">Company Management</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <!-- Stats Row -->
    <div class="row">
        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-aqua"><i class="fa fa-building"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Total Companies</span>
                    <span class="info-box-number" id="totalCompanies">0</span>
                    <div class="progress">
                        <div class="progress-bar" style="width: 100%"></div>
                    </div>
                    <span class="progress-description">All registered companies</span>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-green"><i class="fa fa-check-circle"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Active Companies</span>
                    <span class="info-box-number" id="activeCompanies">0</span>
                    <div class="progress">
                        <div class="progress-bar" id="activeProgress" style="width: 0%"></div>
                    </div>
                    <span class="progress-description">Currently active</span>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-yellow"><i class="fa fa-warning"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Expiring Licenses</span>
                    <span class="info-box-number" id="expiringLicenses">0</span>
                    <div class="progress">
                        <div class="progress-bar" id="expiringProgress" style="width: 0%"></div>
                    </div>
                    <span class="progress-description">Licenses expiring soon</span>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6 col-xs-12">
            <div class="info-box">
                <span class="info-box-icon bg-red"><i class="fa fa-times-circle"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Inactive Companies</span>
                    <span class="info-box-number" id="inactiveCompanies">0</span>
                    <div class="progress">
                        <div class="progress-bar" id="inactiveProgress" style="width: 0%"></div>
                    </div>
                    <span class="progress-description">Inactive status</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row">
        <div class="col-md-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title"><i class="fa fa-filter"></i> Filters & Search</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Search Companies</label>
                                <div class="company-search" style="position: relative;">
                                    <input type="text" class="form-control" id="companySearch" placeholder="Search by name, abbreviation, or location...">
                                    <div class="search-results" id="searchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Location</label>
                                <select class="form-control select2" id="locationFilter" style="width: 100%;">
                                    <option value="">All Locations</option>
                                    <option value="Dubai">Dubai</option>
                                    <option value="Abu Dhabi">Abu Dhabi</option>
                                    <option value="Sharjah">Sharjah</option>
                                    <option value="Ajman">Ajman</option>
                                    <option value="Ras Al Khaimah">Ras Al Khaimah</option>
                                    <option value="Fujairah">Fujairah</option>
                                    <option value="Umm Al Quwain">Umm Al Quwain</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Status</label>
                                <select class="form-control" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>License Status</label>
                                <select class="form-control" id="licenseFilter">
                                    <option value="">All</option>
                                    <option value="valid">Valid</option>
                                    <option value="expiring">Expiring Soon</option>
                                    <option value="expired">Expired</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary btn-block" onclick="applyFilters()">
                                        <i class="fa fa-search"></i> Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button class="btn btn-default" onclick="clearFilters()">
                                <i class="fa fa-refresh"></i> Clear Filters
                            </button>
                            <div class="pull-right">
                                <button class="btn btn-success" onclick="addNewCompany()">
                                    <i class="fa fa-plus"></i> Add New Company
                                </button>
                                <button class="btn btn-warning" onclick="exportCompanies()">
                                    <i class="fa fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Panel -->
    <div class="row" id="bulkActionsRow" style="display: none;">
        <div class="col-md-12">
            <div class="alert alert-warning">
                <div class="row">
                    <div class="col-md-6">
                        <strong><span id="selectedCount">0</span> company(ies) selected</strong>
                    </div>
                    <div class="col-md-6 text-right">
                        <button class="btn btn-sm btn-success" onclick="bulkActivate()">
                            <i class="fa fa-check"></i> Activate
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="bulkDeactivate()">
                            <i class="fa fa-ban"></i> Deactivate
                        </button>
                        <button class="btn btn-sm btn-info" onclick="bulkUpdateLocation()">
                            <i class="fa fa-map-marker"></i> Update Location
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="bulkDelete()">
                            <i class="fa fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Companies Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title"><i class="fa fa-building"></i> Companies List</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-sm btn-default" onclick="refreshTable()">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="companiesTable">
                            <thead>
                                <tr>
                                    <th width="30">
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    <th width="300">Company Information</th>
                                    <th width="200">Contact</th>
                                    <th width="150">Location</th>
                                    <th width="150">License Status</th>
                                    <th width="80">Contracts</th>
                                    <th width="80">Employees</th>
                                    <th width="100">Status</th>
                                    <th width="150">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="companiesTableBody">
                                <!-- Companies will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="loadingSpinner" style="text-align: center; padding: 20px; display: none;">
                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                        <div>Loading companies...</div>
                    </div>
                    <div id="emptyState" style="text-align: center; padding: 40px; display: none;">
                        <i class="fa fa-building fa-3x" style="color: #ccc;"></i>
                        <h4 style="color: #999;">No companies found</h4>
                        <p style="color: #666;">Try adjusting your search criteria or add a new company.</p>
                        <button class="btn btn-primary" onclick="addNewCompany()">
                            <i class="fa fa-plus"></i> Add New Company
                        </button>
                    </div>
                </div>
                <div class="box-footer">
                    <div class="row">
                        <div class="col-sm-5">
                            <div class="dataTables_info">
                                Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalEntries">0</span> entries
                            </div>
                        </div>
                        <div class="col-sm-7">
                            <div class="dataTables_paginate paging_simple_numbers">
                                <ul class="pagination" id="pagination">
                                    <!-- Pagination will be generated here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Company Form Modal -->
<div class="modal fade" id="companyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">
                    <i class="fa fa-building"></i> <span id="modalTitle">Add New Company</span>
                </h4>
            </div>
            <form id="companyForm">
                <div class="modal-body">
                    <input type="hidden" id="companyId" name="CompanyID">
                    <input type="hidden" id="tenantId" name="TenantID" value="1">

                    <!-- Basic Information -->
                    <div class="panel panel-default">
                        <div class="panel-heading"><strong>Basic Information</strong></div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Company Name <span style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="name" name="Name" required>
                                        <span class="help-block" id="nameError" style="color: red; display: none;"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Abbreviation <span style="color: red;">*</span></label>
                                        <input type="text" class="form-control" id="abbreviation" name="Abbrivation" required>
                                        <span class="help-block" id="abbreviationError" style="color: red; display: none;"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Email <span style="color: red;">*</span></label>
                                        <input type="email" class="form-control" id="email" name="Email" required>
                                        <span class="help-block" id="emailError" style="color: red; display: none;"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Website</label>
                                        <input type="url" class="form-control" id="website" name="WebSite" placeholder="https://www.example.com">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="panel panel-default">
                        <div class="panel-heading"><strong>Contact Information</strong></div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Contact Person</label>
                                        <input type="text" class="form-control" id="contactPerson" name="ContactPerson">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Phone</label>
                                        <input type="tel" class="form-control" id="phone" name="Phone" placeholder="+971-50-123-4567">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Fax</label>
                                        <input type="tel" class="form-control" id="fax" name="Fax" placeholder="+971-4-123-4568">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="panel panel-default">
                        <div class="panel-heading"><strong>Location Information</strong></div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Location</label>
                                        <select class="form-control select2" id="location" name="Location" style="width: 100%;">
                                            <option value="">Select Location</option>
                                            <option value="Dubai">Dubai</option>
                                            <option value="Abu Dhabi">Abu Dhabi</option>
                                            <option value="Sharjah">Sharjah</option>
                                            <option value="Ajman">Ajman</option>
                                            <option value="Ras Al Khaimah">Ras Al Khaimah</option>
                                            <option value="Fujairah">Fujairah</option>
                                            <option value="Umm Al Quwain">Umm Al Quwain</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Address</label>
                                        <textarea class="form-control" id="address" name="Address" rows="3" placeholder="Full address"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legal Information -->
                    <div class="panel panel-default">
                        <div class="panel-heading"><strong>Legal Information</strong></div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Tax Number</label>
                                        <input type="text" class="form-control" id="taxNumber" name="TaxNumber">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>License Number</label>
                                        <input type="text" class="form-control" id="licenseNumber" name="LicenseNumber">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>License Expiry Date</label>
                                        <input type="text" class="form-control datepicker" id="licenseExpiryDate" name="LicenseExpiryDate">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>Insurance Details</label>
                                        <textarea class="form-control" id="insuranceDetails" name="InsuranceDetails" rows="3" placeholder="Describe insurance coverage, policy numbers, etc."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="panel panel-default">
                        <div class="panel-heading"><strong>Status</strong></div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="isActive" name="IsActive" checked>
                                    Active Company
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save"></i> Save Company
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Company Modal -->
<div class="modal fade" id="viewCompanyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">
                    <i class="fa fa-info-circle"></i> Company Details
                </h4>
            </div>
            <div class="modal-body" id="viewCompanyContent">
                <!-- Company details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editFromView()">
                    <i class="fa fa-edit"></i> Edit Company
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .company-logo {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background-color: #f4f4f4;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 20px;
        font-weight: bold;
        color: #3c8dbc;
        border: 2px solid #e0e0e0;
    }

    .company-info {
        display: flex;
        align-items: center;
    }

    .company-details {
        flex-grow: 1;
    }

    .company-name {
        font-weight: bold;
        margin-bottom: 2px;
        font-size: 16px;
    }

    .company-type {
        color: #666;
        font-size: 12px;
        display: inline-block;
        background-color: #f0f0f0;
        padding: 2px 8px;
        border-radius: 10px;
        margin-bottom: 2px;
    }

    .company-location {
        color: #888;
        font-size: 12px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
    }

    .license-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 5px;
    }

    .license-valid {
        background-color: #d4edda;
        color: #155724;
    }

    .license-expiring {
        background-color: #fff3cd;
        color: #856404;
    }

    .license-expired {
        background-color: #f8d7da;
        color: #721c24;
    }

    .action-buttons {
        white-space: nowrap;
    }

    .search-result-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }

    .search-result-item:hover {
        background-color: #f5f5f5;
    }

    .pagination {
        margin: 0;
    }
</style>

@section Scripts {
    <script>
        // Global variables
        let currentCompanies = [];
        let filteredCompanies = [];
        let selectedCompanies = new Set();
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalItems = 0;
        let currentCompany = null;
        let viewingCompany = null;

        $(document).ready(function () {
            // Load initial data
            loadCompanies();
            loadStats();

            $('#selectAll').off('change').on('change', function () {
                toggleSelectAll();
            });


            // Search functionality
            $('#companySearch').on('input', function () {
                const searchTerm = $(this).val();
                if (searchTerm.length >= 2) {
                    performSearch(searchTerm);
                } else {
                    $('#searchResults').hide();
                }
            });

            // Hide search results when clicking outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest('.company-search').length) {
                    $('#searchResults').hide();
                }
            });

            // Form validation
            $('#name, #abbreviation, #email').on('blur', function () {
                validateField(this);
            });

            // Form submission
            $('#companyForm').on('submit', function (e) {
                e.preventDefault();
                saveCompany();
            });

            // Reset form when modal is hidden
            $('#companyModal').on('hidden.bs.modal', function () {
                resetForm();
            });
        });

        // $(document).ready(function () {
        //     // Load initial data
        //     loadCompanies();
        //     loadStats();

        //     // === CHECKBOX EVENT HANDLERS - USE EVENT DELEGATION ===

        //     // Header checkbox - using event delegation on document
        //     $(document).on('change', '#selectAll', function () {
        //         console.log('Header checkbox clicked!'); // Debug
        //         const isChecked = $(this).is(':checked');
        //         console.log('Header checkbox state:', isChecked);

        //         // Clear selected companies
        //         selectedCompanies.clear();

        //         // Update all row checkboxes
        //         $('.company-checkbox').each(function () {
        //             $(this).prop('checked', isChecked);
        //             if (isChecked) {
        //                 selectedCompanies.add(parseInt($(this).val()));
        //             }
        //         });

        //         // Update bulk actions
        //         updateBulkActions();
        //         console.log('Selected companies after header click:', Array.from(selectedCompanies));
        //     });

        //     // Row checkboxes - using event delegation on document
        //     $(document).on('change', '.company-checkbox', function () {
        //         console.log('Row checkbox clicked!'); // Debug
        //         const companyId = parseInt($(this).val());
        //         const isChecked = $(this).is(':checked');

        //         if (isChecked) {
        //             selectedCompanies.add(companyId);
        //         } else {
        //             selectedCompanies.delete(companyId);
        //         }

        //         // Update header checkbox state
        //         updateHeaderCheckbox();
        //         updateBulkActions();
        //         console.log('Selected companies after row click:', Array.from(selectedCompanies));
        //     });

        //     // Rest of your existing document.ready code...
        //     $('#companySearch').on('input', function () {
        //         const searchTerm = $(this).val();
            
        //         if (searchTerm.length >= 2) {
        //             performSearch(searchTerm);
        //         } else {
        //             $('#searchResults').hide();
        //         }
        //     });

        //     $(document).on('click', function (e) {
        //         if (!$(e.target).closest('.company-search').length) {
        //             $('#searchResults').hide();
        //         }
        //     });

        //     $('#name, #abbreviation, #email').on('blur', function () {
        //         validateField(this);
        //     });

        //     $('#companyForm').on('submit', function (e) {
        //         e.preventDefault();
        //         saveCompany();
        //     });

        //     $('#companyModal').on('hidden.bs.modal', function () {
        //         resetForm();
        //     });
        // });

        function updateHeaderCheckbox() {
            const totalCheckboxes = $('.company-checkbox').length;
            const checkedCheckboxes = $('.company-checkbox:checked').length;
            const headerCheckbox = $('#selectAll');

            console.log('Updating header checkbox - Total:', totalCheckboxes, 'Checked:', checkedCheckboxes);

            if (checkedCheckboxes === 0) {
                headerCheckbox.prop('indeterminate', false);
                headerCheckbox.prop('checked', false);
            } else if (checkedCheckboxes === totalCheckboxes && totalCheckboxes > 0) {
                headerCheckbox.prop('indeterminate', false);
                headerCheckbox.prop('checked', true);
            } else {
                headerCheckbox.prop('indeterminate', true);
                headerCheckbox.prop('checked', false);
            }
        }


        // Load companies with pagination
        function loadCompanies(page = 1, searchTerm = '') {
            currentPage = page;
            showLoading(true);
            // alert(searchTerm);
            $.get('/Company/GetPaged', {
                page: page,
                pageSize: itemsPerPage,
                searchTerm: searchTerm,
                tenantId: 1
            })
                .done(function (response) {
                    if (response.success) {
                        currentCompanies = response.data.items || [];
                        totalItems = response.data.totalCount || 0;
                        renderCompaniesTable();
                        updatePagination();
                        updateTableInfo();
                    } else {
                        toastr.error('Failed to load companies: ' + response.message);
                    }
                })
                .fail(function () {
                    toastr.error('Failed to load companies. Please try again.');
                })
                .always(function () {
                    showLoading(false);
                });
        }

        // Load statistics
        function loadStats() {
            $.get('/Company/GetStats', { tenantId: 1 })
                .done(function (response) {
                    if (response.success) {
                        const stats = response.data;
                        $('#totalCompanies').text(stats.totalCompanies);
                        $('#activeCompanies').text(stats.activeCompanies);
                        $('#inactiveCompanies').text(stats.inactiveCompanies);
                        $('#expiringLicenses').text(stats.expiringLicenses);

                        // Update progress bars
                        const total = stats.totalCompanies || 1;
                        $('#activeProgress').css('width', ((stats.activeCompanies / total) * 100) + '%');
                        $('#inactiveProgress').css('width', ((stats.inactiveCompanies / total) * 100) + '%');
                        $('#expiringProgress').css('width', ((stats.expiringLicenses / total) * 100) + '%');
                    }
                });
        }

        // Render companies table
        function renderCompaniesTable() {
            const tbody = $('#companiesTableBody');
            tbody.empty();

            if (currentCompanies.length === 0) {
                $('#emptyState').show();
                return;
            }

            $('#emptyState').hide();

            currentCompanies.forEach(company => {
                const row = createCompanyRow(company);
                tbody.append(row);
            });

            // Add event listeners for checkboxes after rendering
            $('.company-checkbox').off('change').on('change', function () {
                handleCompanySelection();
            });

            // Update checkbox states
            updateSelectAllCheckbox();
        }


        // Create company row HTML
        function createCompanyRow(company) {
            const initials = company.abbrivation || company.name.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            const statusClass = company.isActive ? 'status-active' : 'status-inactive';
            const statusText = company.isActive ? 'Active' : 'Inactive';

            // Calculate license status
            let licenseStatus = '';
            if (company.licenseExpiryDate) {
                const expiryDate = new Date(company.licenseExpiryDate);
                const today = new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntilExpiry < 0) {
                    licenseStatus = '<span class="license-badge license-expired"><i class="fa fa-times"></i> Expired</span>';
                } else if (daysUntilExpiry <= 30) {
                    licenseStatus = '<span class="license-badge license-expiring"><i class="fa fa-warning"></i> Expires in ' + daysUntilExpiry + ' days</span>';
                } else {
                    licenseStatus = '<span class="license-badge license-valid"><i class="fa fa-check"></i> Valid</span>';
                }
            } else {
                licenseStatus = '<span class="license-badge" style="background-color: #e9ecef; color: #6c757d;">No License</span>';
            }

            return `
                <tr data-company-id="${company.companyID}">
                    <td>
                        <input type="checkbox" class="company-checkbox" value="${company.companyID}">
                    </td>
                    <td>
                        <div class="company-info">
                            <div class="company-logo">${initials}</div>
                            <div class="company-details">
                                <div class="company-name">${company.name}</div>
                                <span class="company-type">${company.abbrivation || ''}</span>
                                <div class="company-location">
                                    <i class="fa fa-map-marker"></i> ${company.location || 'Not specified'}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>${company.contactPerson || 'Not specified'}</strong><br>
                        <small>${company.email}</small><br>
                        <small>${company.phone || 'No phone'}</small>
                    </td>
                    <td>
                        <i class="fa fa-map-marker"></i> ${company.location || 'Not specified'}<br>
                        <small class="text-muted">${company.address ? (company.address.length > 30 ? company.address.substring(0, 30) + '...' : company.address) : 'No address'}</small>
                    </td>
                    <td>
                        ${licenseStatus}<br>
                        <small class="text-muted">${company.licenseNumber || 'No license number'}</small>
                    </td>
                    <td>
                        <span class="badge bg-blue">${company.totalContract || 0}</span><br>
                        <small class="text-muted">Total</small>
                    </td>
                    <td>
                        <span class="badge bg-green">${company.totalEmployee || 0}</span><br>
                        <small class="text-muted">Total</small>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-xs btn-info" onclick="viewCompany(${company.companyID})" title="View Details">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn-xs btn-primary" onclick="editCompany(${company.companyID})" title="Edit Company">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-xs btn-warning" onclick="toggleCompanyStatus(${company.companyID})" title="Toggle Status">
                                <i class="fa fa-power-off"></i>
                            </button>
                            <button class="btn btn-xs btn-danger" onclick="deleteCompany(${company.companyID})" title="Delete Company">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Search functionality
        function performSearch(searchTerm) {
            $.get('/Company/Search', {
                term: searchTerm,
                tenantId: 1
            })
                .done(function (response) {
                    if (response.success && response.data) {
                        displaySearchResults(response.data);
                    } else {
                        $('#searchResults').html('<div class="search-result-item">No companies found</div>').show();
                    }
                })
                .fail(function () {
                    $('#searchResults').html('<div class="search-result-item">Error searching companies</div>').show();
                });
        }

        function displaySearchResults(results) {
            const searchResults = $('#searchResults');
            searchResults.empty();

            if (results.length === 0) {
                searchResults.html('<div class="search-result-item">No companies found</div>');
            } else {
                results.slice(0, 5).forEach(company => {
                    const initials = company.abbrivation || company.name.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
                    const location = company.location || 'Location not specified';
                    const item = $(`
                        <div class="search-result-item" onclick="selectSearchResult(${company.companyID})">
                            <div class="company-info">
                                <div class="company-logo" style="width: 30px; height: 30px; font-size: 12px;">${initials}</div>
                                <div class="company-details">
                                    <div class="company-name">${company.name}</div>
                                    <div class="company-location">${location}</div>
                                </div>
                            </div>
                        </div>
                    `);
                    searchResults.append(item);
                });
            }

            searchResults.show();
        }

        function selectSearchResult(companyId) {
            $('#companySearch').val('');
            $('#searchResults').hide();
            loadCompanies(1, ''); // Reset to show all companies
            // Optionally scroll to or highlight the selected company
        }

        // CRUD Operations
        function addNewCompany() {
            currentCompany = null;
            $('#modalTitle').text('Add New Company');
            resetForm();
            $('#companyModal').modal('show');
        }

        function editCompany(companyId) {
            $.get('/Company/GetById', { id: companyId, tenantId: 1 })
                .done(function (response) {
                    if (response.success && response.data) {
                        currentCompany = response.data;
                        $('#modalTitle').text('Edit Company');
                        populateForm(response.data);
                        $('#companyModal').modal('show');
                    } else {
                        toastr.error('Company not found');
                    }
                });
        }

        function viewCompany(companyId) {
            $.get('/Company/GetById', { id: companyId, tenantId: 1 })
                .done(function (response) {
                    if (response.success && response.data) {
                        viewingCompany = response.data;
                        populateViewModal(response.data);
                        $('#viewCompanyModal').modal('show');
                    } else {
                        toastr.error('Company not found');
                    }
                });
        }

        function saveCompany() {
            if (!validateForm()) {
                return;
            }

            const formData = getFormData();
            const url = currentCompany ? '/Company/Update' : '/Company/Create';
            const method = currentCompany ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#companyModal').modal('hide');
                        loadCompanies(currentPage);
                        loadStats();
                    } else {
                        toastr.error(response.message);
                        if (response.errors) {
                            response.errors.forEach(error => toastr.error(error));
                        }
                    }
                },
                error: function () {
                    toastr.error('Failed to save company. Please try again.');
                }
            });
        }

        function deleteCompany(companyId) {
            const company = currentCompanies.find(c => c.companyID === companyId);
            if (!company) return;

            Swal.fire({
                title: 'Delete Company?',
                html: `<div style="text-align: left;">
                    <p>Are you sure you want to delete this company?</p>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <strong>${company.name}</strong><br>
                        <small style="color: #666;">${company.abbrivation || ''}</small><br>
                        <small style="color: #666;">${company.location || ''}</small>
                    </div>
                    <p style="color: #dc3545; font-weight: bold;">
                        <i class="fa fa-exclamation-triangle"></i> This action cannot be undone!
                    </p>
                </div>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete company!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Company/Delete',
                        method: 'DELETE',
                        data: { id: companyId, tenantId: 1 },
                        success: function (response) {
                            if (response.success) {
                                toastr.success(response.message);
                                loadCompanies(currentPage);
                                loadStats();
                            } else {
                                toastr.error(response.message);
                            }
                        },
                        error: function () {
                            toastr.error('Failed to delete company. Please try again.');
                        }
                    });
                }
            });
        }

        function toggleCompanyStatus(companyId) {
            const company = currentCompanies.find(c => c.companyID === companyId);
            if (!company) return;

            const newStatus = !company.isActive;
            const actionText = newStatus ? 'activate' : 'deactivate';
            const endpoint = newStatus ? 'Activate' : 'Deactivate';

            Swal.fire({
                title: `${actionText.charAt(0).toUpperCase() + actionText.slice(1)} Company?`,
                html: `Are you sure you want to ${actionText} <strong>${company.name}</strong>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3c8dbc',
                cancelButtonColor: '#6c757d',
                confirmButtonText: `Yes, ${actionText}!`,
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post(`/Company/${endpoint}`, { id: companyId, tenantId: 1 })
                        .done(function (response) {
                            if (response.success) {
                                toastr.success(response.message);
                                loadCompanies(currentPage);
                                loadStats();
                            } else {
                                toastr.error(response.message);
                            }
                        })
                        .fail(function () {
                            toastr.error(`Failed to ${actionText} company. Please try again.`);
                        });
                }
            });
        }

        // Bulk Operations
        function toggleSelectAll() {

            alert("hi");
            const selectAll = $('#selectAll').prop('checked');
            $('.company-checkbox').prop('checked', selectAll);

            // Clear the selectedCompanies set and repopulate it
            selectedCompanies.clear();
            if (selectAll) {
                $('.company-checkbox').each(function () {
                    selectedCompanies.add(parseInt($(this).val()));
                });
            }

            // Update the UI
            updateBulkActionsDisplay();
        }

        function handleCompanySelection() {
            selectedCompanies.clear();
            $('.company-checkbox:checked').each(function () {
                selectedCompanies.add(parseInt($(this).val()));
            });

            updateBulkActionsDisplay();
            updateSelectAllCheckbox();
        }

        // New helper function to update bulk actions display
        function updateBulkActionsDisplay() {
            const count = selectedCompanies.size;
            $('#selectedCount').text(count);

            if (count > 0) {
                $('#bulkActionsRow').show();
            } else {
                $('#bulkActionsRow').hide();
            }
        }
        function updateSelectAllCheckbox() {
            const totalCheckboxes = $('.company-checkbox').length;
            const checkedCheckboxes = $('.company-checkbox:checked').length;

            if (checkedCheckboxes === 0) {
                $('#selectAll').prop('indeterminate', false);
                $('#selectAll').prop('checked', false);
            } else if (checkedCheckboxes === totalCheckboxes) {
                $('#selectAll').prop('indeterminate', false);
                $('#selectAll').prop('checked', true);
            } else {
                $('#selectAll').prop('indeterminate', true);
                $('#selectAll').prop('checked', false);
            }
        }

        function bulkActivate() {
            if (selectedCompanies.size === 0) return;
            bulkAction('activate', 'Activate');
        }

        function bulkDeactivate() {
            if (selectedCompanies.size === 0) return;
            bulkAction('deactivate', 'Deactivate');
        }

        function bulkDelete() {
            if (selectedCompanies.size === 0) return;
            bulkAction('delete', 'Delete');
        }

        function bulkUpdateLocation() {
            if (selectedCompanies.size === 0) return;

            const locationOptions = `
                <option value="">-- Select Location --</option>
                <option value="Dubai">Dubai</option>
                <option value="Abu Dhabi">Abu Dhabi</option>
                <option value="Sharjah">Sharjah</option>
                <option value="Ajman">Ajman</option>
                <option value="Ras Al Khaimah">Ras Al Khaimah</option>
                <option value="Fujairah">Fujairah</option>
                <option value="Umm Al Quwain">Umm Al Quwain</option>
            `;

            Swal.fire({
                title: 'Update Location',
                html: `
                    <p>Select a location for <strong>${selectedCompanies.size}</strong> selected company(ies):</p>
                    <select id="bulkLocationSelect" class="swal2-input" style="width: 80%; padding: 10px;">
                        ${locationOptions}
                    </select>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#3c8dbc',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Update Location',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const selectedLocation = document.getElementById('bulkLocationSelect').value;
                    if (!selectedLocation) {
                        Swal.showValidationMessage('Please select a location');
                        return false;
                    }
                    return selectedLocation;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    bulkAction('updatelocation', 'Update Location', result.value);
                }
            });
        }

        function bulkAction(action, actionName, newValue = '') {
            const companyIds = Array.from(selectedCompanies);

            $.ajax({
                url: '/Company/BulkUpdate',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    companyIds: companyIds,
                    action: action,
                    newValue: newValue,
                    tenantId: 1
                }),
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        clearSelection();
                        loadCompanies(currentPage);
                        loadStats();
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function () {
                    toastr.error(`Failed to ${actionName.toLowerCase()}. Please try again.`);
                }
            });
        }
        // Updated clearSelection function
        function clearSelection() {
            selectedCompanies.clear();
            $('.company-checkbox').prop('checked', false);
            $('#selectAll').prop('checked', false).prop('indeterminate', false);
            $('#bulkActionsRow').hide();
        }


        // Form Functions
        function resetForm() {
            $('#companyForm')[0].reset();
            $('#companyId').val('');
            $('#location').val('').trigger('change');
            $('#isActive').prop('checked', true);
            clearValidationErrors();
        }

        function populateForm(company) {
            $('#companyId').val(company.companyID);
            $('#name').val(company.name);
            $('#abbreviation').val(company.abbrivation);
            $('#email').val(company.email);
            $('#website').val(company.webSite);
            $('#contactPerson').val(company.contactPerson);
            $('#phone').val(company.phone);
            $('#fax').val(company.fax);
            $('#location').val(company.location).trigger('change');
            $('#address').val(company.address);
            $('#taxNumber').val(company.taxNumber);
            $('#licenseNumber').val(company.licenseNumber);
            $('#licenseExpiryDate').val(company.licenseExpiryDate ? company.licenseExpiryDate.split('T')[0] : '');
            $('#insuranceDetails').val(company.insuranceDetails);
            $('#isActive').prop('checked', company.isActive);
        }

        function getFormData() {
            return {
                companyID: $('#companyId').val() || 0,
                tenantID: 1,
                name: $('#name').val(),
                abbrivation: $('#abbreviation').val(),
                email: $('#email').val(),
                webSite: $('#website').val(),
                contactPerson: $('#contactPerson').val(),
                phone: $('#phone').val(),
                fax: $('#fax').val(),
                location: $('#location').val(),
                address: $('#address').val(),
                taxNumber: $('#taxNumber').val(),
                licenseNumber: $('#licenseNumber').val(),
                licenseExpiryDate: $('#licenseExpiryDate').val() || null,
                insuranceDetails: $('#insuranceDetails').val(),
                isActive: $('#isActive').is(':checked')
            };
        }

        function populateViewModal(company) {
            const initials = company.abbrivation || company.name.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            const statusClass = company.isActive ? 'status-active' : 'status-inactive';
            const statusText = company.isActive ? 'Active' : 'Inactive';

            // Calculate license status
            let licenseStatus = '';
            if (company.licenseExpiryDate) {
                const expiryDate = new Date(company.licenseExpiryDate);
                const today = new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntilExpiry < 0) {
                    licenseStatus = '<span class="license-badge license-expired"><i class="fa fa-times"></i> Expired</span>';
                } else if (daysUntilExpiry <= 30) {
                    licenseStatus = '<span class="license-badge license-expiring"><i class="fa fa-warning"></i> Expiring Soon</span>';
                } else {
                    licenseStatus = '<span class="license-badge license-valid"><i class="fa fa-check"></i> Valid License</span>';
                }
            } else {
                licenseStatus = '<span class="license-badge" style="background-color: #e9ecef; color: #6c757d;">No License</span>';
            }

            const content = `
                <div style="background: linear-gradient(135deg, #3c8dbc 0%, #357ca5 100%); border-radius: 8px; padding: 20px; margin-bottom: 25px; color: white;">
                    <div class="company-info">
                        <div class="company-logo" style="width: 80px; height: 80px; font-size: 32px; background-color: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white;">${initials}</div>
                        <div class="company-details" style="color: white;">
                            <div class="company-name" style="font-size: 22px; font-weight: 600; margin-bottom: 5px;">${company.name}</div>
                            <span class="company-type" style="background-color: rgba(255,255,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.4);">${company.abbrivation || 'Company'}</span>
                            ${licenseStatus}
                            <div class="company-location" style="color: rgba(255,255,255,0.9); font-size: 14px; margin-top: 5px;">
                                <i class="fa fa-map-marker"></i> ${company.location || 'Location not specified'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading"><strong>Contact Information</strong></div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Contact Person</span>
                                    <span style="color: #344767; font-size: 14px;">${company.contactPerson || 'Not specified'}</span>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Email</span>
                                    <span style="color: #344767; font-size: 14px;">${company.email || 'Not specified'}</span>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Phone</span>
                                    <span style="color: #344767; font-size: 14px;">${company.phone || 'Not specified'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Fax</span>
                                    <span style="color: #344767; font-size: 14px;">${company.fax || 'Not specified'}</span>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Website</span>
                                    <span style="color: #344767; font-size: 14px;">
                                        ${company.webSite ? `<a href="${company.webSite}" target="_blank">${company.webSite}</a>` : 'Not specified'}
                                    </span>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Address</span>
                                    <span style="color: #344767; font-size: 14px;">${company.address || 'Not specified'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading"><strong>Legal Information</strong></div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Tax Number</span>
                                    <span style="color: #344767; font-size: 14px;">${company.taxNumber || 'Not specified'}</span>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">License Number</span>
                                    <span style="color: #344767; font-size: 14px;">${company.licenseNumber || 'Not specified'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">License Expiry Date</span>
                                    <span style="color: #344767; font-size: 14px;">${company.licenseExpiryDate ? formatDate(company.licenseExpiryDate) : 'Not specified'}</span>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Insurance Details</span>
                                    <span style="color: #344767; font-size: 14px;">${company.insuranceDetails || 'Not specified'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel panel-default">
                    <div class="panel-heading"><strong>Additional Information</strong></div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Status</span>
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Created Date</span>
                                    <span style="color: #344767; font-size: 14px;">${company.createdDate ? formatDate(company.createdDate) : 'Not available'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                                    <span style="font-weight: 600; color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; display: block;">Last Modified</span>
                                    <span style="color: #344767; font-size: 14px;">${company.lastModifiedDate ? formatDate(company.lastModifiedDate) : 'Not available'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#viewCompanyContent').html(content);
        }

        function editFromView() {
            if (viewingCompany) {
                $('#viewCompanyModal').modal('hide');
                setTimeout(() => {
                    editCompany(viewingCompany.companyID);
                }, 500);
            }
        }

        // Validation Functions
        function validateField(field) {
            const fieldName = $(field).attr('name').toLowerCase();
            const value = $(field).val();
            const companyId = $('#companyId').val();

            if (value && (fieldName === 'name' || fieldName === 'abbrivation' || fieldName === 'email')) {
                $.post('/Company/ValidateUnique', {
                    field: fieldName === 'abbrivation' ? 'abbreviation' : fieldName,
                    value: value,
                    excludeId: companyId || null,
                    tenantId: 1
                })
                    .done(function (response) {
                        if (response.success) {
                            if (!response.isUnique) {
                                showFieldError(fieldName, response.message);
                            } else {
                                clearFieldError(fieldName);
                            }
                        }
                    });
            }
        }

        function validateForm() {
            clearValidationErrors();
            let isValid = true;

            // Required field validation
            const requiredFields = ['name', 'abbreviation', 'email'];
            requiredFields.forEach(field => {
                const value = $(`#${field}`).val();
                if (!value || value.trim() === '') {
                    showFieldError(field, `${field.charAt(0).toUpperCase() + field.slice(1)} is required`);
                    isValid = false;
                }
            });

            // Email validation
            const email = $('#email').val();
            if (email && !isValidEmail(email)) {
                showFieldError('email', 'Please enter a valid email address');
                isValid = false;
            }

            return isValid;
        }

        function showFieldError(fieldName, message) {
            $(`#${fieldName}Error`).text(message).show();
            $(`#${fieldName}`).addClass('has-error');
        }

        function clearFieldError(fieldName) {
            $(`#${fieldName}Error`).hide();
            $(`#${fieldName}`).removeClass('has-error');
        }

        function clearValidationErrors() {
            $('.help-block').hide();
            $('.form-control').removeClass('has-error');
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
            return emailRegex.test(email);
        }

        // Filter Functions
        function applyFilters() {
            const searchTerm = $('#companySearch').val();
            const locationFilter = $('#locationFilter').val();
            const statusFilter = $('#statusFilter').val();
            const licenseFilter = $('#licenseFilter').val();
            //alert(searchTerm);
            // For now, we'll use the search term. In a real implementation, 
            // you'd modify the backend to handle all filter parameters
            loadCompanies(1, searchTerm);
            toastr.info('Filters applied');
        }

        function clearFilters() {
            $('#locationFilter').val('').trigger('change');
            $('#statusFilter').val('');
            $('#licenseFilter').val('');
            $('#companySearch').val('');

            loadCompanies(1, '');
            toastr.info('Filters cleared');
        }

        // Utility Functions
        function showLoading(show) {
            if (show) {
                $('#loadingSpinner').show();
                $('#companiesTable').hide();
                $('#emptyState').hide();
            } else {
                $('#loadingSpinner').hide();
                $('#companiesTable').show();
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) return;

            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`<li class="${prevDisabled}"><a href="#" onclick="changePage(${currentPage - 1})">&laquo;</a></li>`);

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                pagination.append('<li><a href="#" onclick="changePage(1)">1</a></li>');
                if (startPage > 2) {
                    pagination.append('<li class="disabled"><span>...</span></li>');
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                pagination.append(`<li class="${activeClass}"><a href="#" onclick="changePage(${i})">${i}</a></li>`);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagination.append('<li class="disabled"><span>...</span></li>');
                }
                pagination.append(`<li><a href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`);
            }

            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`<li class="${nextDisabled}"><a href="#" onclick="changePage(${currentPage + 1})">&raquo;</a></li>`);
        }

        function changePage(page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (page < 1 || page > totalPages) return;

            loadCompanies(page, $('#companySearch').val());
            clearSelection();
        }

        function updateTableInfo() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, totalItems);

            $('#showingStart').text(totalItems > 0 ? startIndex : 0);
            $('#showingEnd').text(endIndex);
            $('#totalEntries').text(totalItems);
        }

        function refreshTable() {
            loadCompanies(currentPage, $('#companySearch').val());
            loadStats();
            toastr.info('Table refreshed');
        }

        function exportCompanies() {
            window.open('/Company/Export?tenantId=1', '_blank');
            toastr.success('Export started. Download will begin shortly.');
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not available';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Keyboard shortcuts
        $(document).on('keydown', function (e) {
            // Ctrl+N for new company
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                addNewCompany();
            }

            // Ctrl+F for search focus
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                $('#companySearch').focus();
            }

            // Ctrl+R for refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshTable();
            }

            // Escape to close modals
            if (e.key === 'Escape') {
                $('.modal').modal('hide');
                $('#searchResults').hide();
            }
        });

        // Configure toastr options
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
    </script>
}